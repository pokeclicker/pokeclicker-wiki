const fs = require('fs');
const path = require('path');
const glob = require('glob');

// Root directory where local image assets live
const imagesRoot = path.resolve(__dirname, '..', 'pokeclicker', 'docs', 'assets', 'images');

// File to generate that will be used by the service worker
const outputFile = path.resolve(__dirname, 'imageAssets.js');

// Match common image extensions
const pattern = '**/*.+(png|jpg|jpeg|gif|svg|webp|ico)';

glob(pattern, {
  cwd: imagesRoot,
  nodir: true,
  nocase: true,
  // Exclude dynamic-background assets from the generated list
  ignore: ['dynamic-background/**'],
}, (err, files) => {
  if (err) {
    console.error('Error while collecting image assets:', err);
    process.exit(1);
  }

  // Normalize to forward slashes and sort for deterministic output
  const normalized = files
    .map((f) => f.replace(/\\/g, '/'))
    .sort();

  const fileContents = `// Auto-generated by scripts/generate-image-list.js\n` +
    `// Contains relative paths under pokeclicker/docs/assets/images\n` +
    `self.POKEC_CLICKER_IMAGE_ASSETS = ${JSON.stringify(normalized, null, 2)};\n`;

  try {
    fs.writeFileSync(outputFile, fileContents, 'utf8');
    console.log(`Generated ${normalized.length} image paths in ${path.relative(process.cwd(), outputFile)}`);
  } catch (writeErr) {
    console.error('Failed to write image assets file:', writeErr);
    process.exit(1);
  }
});
